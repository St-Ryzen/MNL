{% extends "base.html" %}

{% block page_title %}{% if current_user.is_admin %}Dashboard{% else %}My Accounts{% endif %}{% endblock %}

{% block content %}
    <!-- Update notification section - Available to all authenticated users -->
    <div id="update-notification" class="update-notification">
        <div class="update-notification-content">
            <div>
                <h4><i class="fas fa-rocket"></i> Update Available!</h4>
                <div id="update-details"></div>
            </div>
            <div>
                <button id="install-update-btn" class="btn btn-success">
                    <i class="fas fa-download"></i> Install Update
                </button>
                <button id="dismiss-update-btn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Dismiss
                </button>
            </div>
        </div>
    </div>
    
    <!-- Overview Statistics - Admin Only -->
    {% if current_user.is_admin %}
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="stat-content">
                <h3>{{ accounts|length }}</h3>
                <p>Model Accounts</p>
                <a href="{{ url_for('model_accounts') }}" class="stat-link">
                    <i class="fas fa-arrow-right"></i> Manage
                </a>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>{{ users|length }}</h3>
                <p>Total Users</p>
                <a href="{{ url_for('user_management') }}" class="stat-link">
                    <i class="fas fa-arrow-right"></i> Manage
                </a>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-link"></i>
            </div>
            <div class="stat-content">
                <h3>{{ assigned_accounts_count or 0 }}</h3>
                <p>Assigned Accounts</p>
                <a href="{{ url_for('model_accounts') }}" class="stat-link">
                    <i class="fas fa-arrow-right"></i> View
                </a>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="stat-content">
                <h3>{{ unassigned_accounts_count or 0 }}</h3>
                <p>Unassigned Accounts</p>
                <a href="{{ url_for('model_accounts') }}" class="stat-link">
                    <i class="fas fa-arrow-right"></i> Assign
                </a>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions - Admin Only -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
        </div>
        <div class="card-body">
            <div class="quick-actions">
                <a href="{{ url_for('setup_accounts') }}" class="action-btn">
                    <i class="fas fa-user-plus"></i>
                    <span>Add Model Account</span>
                </a>
                <a href="{{ url_for('add_user') }}" class="action-btn">
                    <i class="fas fa-user-plus"></i>
                    <span>Add Chatter</span>
                </a>
                <a href="{{ url_for('model_accounts') }}" class="action-btn">
                    <i class="fas fa-user-circle"></i>
                    <span>Manage Accounts</span>
                </a>
                <a href="{{ url_for('user_management') }}" class="action-btn">
                    <i class="fas fa-users"></i>
                    <span>Manage Users</span>
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- For Non-Admin Users: Show Their Assigned Accounts - Board Style -->
    {% if not current_user.is_admin and accounts %}
    <div class="card">
        <div class="card-header">
            <h3>Enjoy your Shift!!!</h3>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">Creator-Side Management</p>
        </div>
        <div class="card-body">
            <div class="model-board-grid">
                {% for account in accounts %}
                <div class="model-card">
                    <div class="model-card-header">
                        <div class="model-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="model-info">
                            <h4 class="model-name">{{ account.model_username }}</h4>
                            <div class="model-status">
                                <span class="status-indicator status-online"></span>
                                <span class="status-text">Ready</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="model-card-body">
                        <div class="model-details">
                            <div class="detail-item">
                                <i class="fas fa-id-card detail-icon"></i>
                                <span class="detail-label">Account ID</span>
                                <span class="detail-value">#{{ account.id }}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-calendar detail-icon"></i>
                                <span class="detail-label">Assigned</span>
                                <span class="detail-value">Active</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="model-card-footer">
                        <div class="action-buttons">
                            <button class="btn btn-action btn-setup" onclick="launchAccount({{ account.id }})" title="Set Up Account (First Time - Restore from Supabase)">
                                <i class="fas fa-cog"></i>
                                <span>Set Up</span>
                            </button>
                            <button class="btn btn-action btn-save" onclick="backupWithExtension({{ account.id }})" title="Save Profile with Extensions (After Installing)">
                                <i class="fas fa-save"></i>
                                <span>Save</span>
                            </button>
                            <button class="btn btn-action btn-launch" onclick="launchAccountLocal({{ account.id }})" title="Launch Account (Use Local Profile with Extensions)">
                                <i class="fas fa-play"></i>
                                <span>Launch</span>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% elif not current_user.is_admin %}
    <div class="card">
        <div class="card-body" style="text-align: center; padding: 60px 40px; color: #666;">
            <i class="fas fa-th-large" style="font-size: 64px; margin-bottom: 25px; color: #ddd;"></i>
            <h3 style="margin-bottom: 15px; color: #5a6c7d;">Welcome to Model Board</h3>
            <p style="font-size: 18px; margin-bottom: 25px; line-height: 1.6;">
                Your model accounts will appear here once assigned by your administrator.<br>
                Contact your team lead to get started.
            </p>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 30px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #e1e5e9; width: 200px;">
                    <i class="fas fa-user-plus" style="font-size: 24px; color: #5a6c7d; margin-bottom: 15px;"></i>
                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">Get Assigned</h4>
                    <p style="font-size: 14px; margin: 0; color: #718096;">Contact admin</p>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #e1e5e9; width: 200px;">
                    <i class="fas fa-question-circle" style="font-size: 24px; color: #5a6c7d; margin-bottom: 15px;"></i>
                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">Need Help?</h4>
                    <p style="font-size: 14px; margin: 0; color: #718096;">Documentation</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <script>
        
        async function launchAccount(accountId) {
            // Find the launch button for this account
            const launchButton = event.target.closest('button');
            const originalText = launchButton.innerHTML;
            
            try {
                // Show loading state
                launchButton.disabled = true;
                launchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Launching...';
                launchButton.classList.add('btn-launching');
                
                const response = await fetch(`/launch_account/${accountId}`, {
                    method: 'GET'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success state
                    launchButton.innerHTML = '<i class="fas fa-check"></i> Launched!';
                    launchButton.classList.remove('btn-launching');
                    launchButton.classList.add('btn-launched');
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        launchButton.disabled = false;
                        launchButton.innerHTML = originalText;
                        launchButton.classList.remove('btn-launched');
                    }, 3000);
                    
                    console.log('Browser session started successfully! ' + result.message);
                } else {
                    // Show error state
                    launchButton.innerHTML = '<i class="fas fa-times"></i> Error';
                    launchButton.classList.remove('btn-launching');
                    launchButton.classList.add('btn-error');
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        launchButton.disabled = false;
                        launchButton.innerHTML = originalText;
                        launchButton.classList.remove('btn-error');
                    }, 2000);
                    
                    alert('Error launching account: ' + result.message);
                }
            } catch (error) {
                // Show error state
                launchButton.innerHTML = '<i class="fas fa-times"></i> Error';
                launchButton.classList.remove('btn-launching');
                launchButton.classList.add('btn-error');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    launchButton.disabled = false;
                    launchButton.innerHTML = originalText;
                    launchButton.classList.remove('btn-error');
                }, 2000);
                
                alert('Error launching account: ' + error.message);
            }
        }
        
        
        // Auto-update functions
        let currentUpdateInfo = null;
        
        async function checkForUpdates() {
            try {
                const response = await fetch('/api/check-updates');
                const updateInfo = await response.json();
                
                if (updateInfo.update_available) {
                    currentUpdateInfo = updateInfo;
                    showUpdateNotification(updateInfo);
                }
            } catch (error) {
                console.error('Error checking for updates:', error);
            }
        }
        
        function showUpdateNotification(updateInfo) {
            const notification = document.getElementById('update-notification');
            const details = document.getElementById('update-details');
            
            details.innerHTML = `
                <div style="margin-top: 8px;">
                    New version <strong>${updateInfo.latest_version}</strong> is available! 
                    <br><small style="opacity: 0.8;">Current: ${updateInfo.current_version}</small>
                </div>
            `;
            
            notification.style.display = 'block';
        }
        
        async function installUpdate() {
            if (!currentUpdateInfo) return;
            
            const installBtn = document.getElementById('install-update-btn');
            const originalText = installBtn.textContent;
            
            try {
                installBtn.textContent = 'Installing...';
                installBtn.disabled = true;
                
                const response = await fetch('/api/install-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Update successful! The application will restart automatically. New version: ${currentUpdateInfo.latest_version}`);
                    // The application should restart automatically
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    alert('Update failed: ' + result.message);
                    installBtn.textContent = originalText;
                    installBtn.disabled = false;
                }
            } catch (error) {
                alert('Error installing update: ' + error.message);
                installBtn.textContent = originalText;
                installBtn.disabled = false;
            }
        }
        
        function dismissUpdate() {
            document.getElementById('update-notification').style.display = 'none';
            currentUpdateInfo = null;
        }
        
        
        // Check for updates when page loads (available to all authenticated users)
        document.addEventListener('DOMContentLoaded', function() {
            // Check for updates immediately
            checkForUpdates();
            
            // Set up periodic checking (every 30 minutes)
            setInterval(checkForUpdates, 30 * 60 * 1000);

            // Set up event listeners - available to all authenticated users
            if (document.getElementById('install-update-btn')) {
                document.getElementById('install-update-btn').addEventListener('click', installUpdate);
            }
            if (document.getElementById('dismiss-update-btn')) {
                document.getElementById('dismiss-update-btn').addEventListener('click', dismissUpdate);
            }
        });
    </script>
    
    <style>
        /* Overview Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e1e5e9;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(90, 108, 125, 0.15);
            border-color: #5a6c7d;
        }
        
        .stat-icon {
            font-size: 32px;
            color: #5a6c7d;
            margin-bottom: 15px;
        }
        
        .stat-content h3 {
            font-size: 36px;
            font-weight: 700;
            color: #333;
            margin: 0 0 8px 0;
        }
        
        .stat-content p {
            color: #666;
            margin: 0 0 15px 0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #5a6c7d;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .stat-link:hover {
            color: #4a5966;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            color: #5a6c7d;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            background: #5a6c7d;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-btn i {
            font-size: 24px;
        }
        
        .action-btn span {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Compact account styles for chatter view */
        .accounts-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .account-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .account-row:hover {
            border-color: #5a6c7d;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .account-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }
        
        .account-name {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 200px;
        }
        
        .account-icon {
            color: #5a6c7d;
            font-size: 16px;
        }
        
        .account-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .account-actions .btn {
            margin: 0;
        }
        
        /* Launch button animation states */
        .btn-launching {
            background: #4a5568 !important;
            cursor: not-allowed !important;
            animation: pulse 1.5s infinite;
        }
        
        .btn-launched {
            background: #48bb78 !important;
            cursor: not-allowed !important;
        }
        
        .btn-error {
            background: #e53e3e !important;
            cursor: not-allowed !important;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Spinner animation is already included in Font Awesome */
        .fa-spin {
            animation: fa-spin 1s infinite linear;
        }
        
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Launch button animation states */
        .btn-launching {
            background: #4a5568 !important;
            cursor: not-allowed !important;
            animation: pulse 1.5s infinite;
        }

        .btn-launched {
            background: #48bb78 !important;
            cursor: not-allowed !important;
        }

        .btn-error {
            background: #e53e3e !important;
            cursor: not-allowed !important;
        }
        
        /* Local launch button animation states */
        .btn-launching-local {
            background: #4a5568 !important;
            cursor: not-allowed !important;
            animation: pulse 1.5s infinite;
        }

        .btn-launched-local {
            background: #48bb78 !important;
            cursor: not-allowed !important;
        }

        .btn-error-local {
            background: #e53e3e !important;
            cursor: not-allowed !important;
        }
        
        /* Extension backup button animation states */
        .btn-backup-ext {
            background: #4a5568 !important;
            cursor: not-allowed !important;
            animation: pulse 1.5s infinite;
        }

        .btn-backup-success {
            background: #48bb78 !important;
            cursor: not-allowed !important;
        }

        .btn-backup-error {
            background: #e53e3e !important;
            cursor: not-allowed !important;
        }
        
        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .account-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .account-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                width: 100%;
            }
            
            .account-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        /* Model Board Grid - Card Layout */
        .model-board-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }
        
        .model-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .model-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(90, 108, 125, 0.15);
            border-color: #5a6c7d;
        }
        
        .model-card-header {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .model-avatar {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .model-avatar i {
            font-size: 24px;
            color: #5a6c7d;
        }
        
        .model-info {
            flex: 1;
        }
        
        .model-name {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            line-height: 1.3;
        }
        
        .model-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
        }
        
        .status-text {
            font-size: 13px;
            color: #718096;
            font-weight: 500;
        }
        
        .model-card-body {
            padding: 20px;
            flex: 1;
        }
        
        .model-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .detail-icon {
            width: 20px;
            text-align: center;
            color: #a0aec0;
            font-size: 14px;
        }
        
        .detail-label {
            font-size: 13px;
            color: #718096;
            flex: 1;
        }
        
        .detail-value {
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
        }
        
        .model-card-footer {
            padding: 0 20px 20px;
            border-top: 1px solid #f1f5f9;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .btn-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 8px;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            background: white;
            color: #2d3748;
        }
        
        .btn-action i {
            font-size: 16px;
        }
        
        .btn-action span {
            line-height: 1.2;
        }
        
        .btn-action:hover {
            border-color: #5a6c7d;
            background: #f8f9fa;
            transform: translateY(-1px);
        }
        
        .btn-setup {
            background: #5a6c7d;
            color: white;
            border-color: #5a6c7d;
        }
        
        .btn-setup:hover {
            background: #4a5568;
            border-color: #4a5568;
            transform: translateY(-1px);
        }
        
        .btn-save {
            background: #718096;
            color: white;
            border-color: #718096;
        }
        
        .btn-save:hover {
            background: #5a6c7d;
            border-color: #5a6c7d;
            transform: translateY(-1px);
        }
        
        .btn-launch {
            background: #48bb78;
            color: white;
            border-color: #48bb78;
        }
        
        .btn-launch:hover {
            background: #38a169;
            border-color: #38a169;
            transform: translateY(-1px);
        }
    </style>
    
    <script>
        // Launch account with Supabase restoration (Set Up button)
        async function launchAccount(accountId) {
            // Find the launch button for this account
            const launchButton = event.target.closest('button');
            const originalText = launchButton.innerHTML;

            try {
                // Show loading state
                launchButton.disabled = true;
                launchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Setting Up...';
                launchButton.classList.add('btn-launching');

                const response = await fetch(`/launch_account/${accountId}`, {
                    method: 'GET'
                });

                const result = await response.json();

                if (result.success) {
                    // Show success state
                    launchButton.innerHTML = '<i class="fas fa-check"></i> Set Up!';
                    launchButton.classList.remove('btn-launching');
                    launchButton.classList.add('btn-launched');

                    // Reset button after 3 seconds
                    setTimeout(() => {
                        launchButton.disabled = false;
                        launchButton.innerHTML = originalText;
                        launchButton.classList.remove('btn-launched');
                    }, 3000);

                    console.log('Browser session started successfully! ' + result.message);
                } else {
                    // Show error state
                    launchButton.innerHTML = '<i class="fas fa-times"></i> Error';
                    launchButton.classList.remove('btn-launching');
                    launchButton.classList.add('btn-error');

                    // Reset button after 2 seconds
                    setTimeout(() => {
                        launchButton.disabled = false;
                        launchButton.innerHTML = originalText;
                        launchButton.classList.remove('btn-error');
                    }, 2000);

                    alert('Error setting up account: ' + result.message);
                }
            } catch (error) {
                // Show error state
                launchButton.innerHTML = '<i class="fas fa-times"></i> Error';
                launchButton.classList.remove('btn-launching');
                launchButton.classList.add('btn-error');

                // Reset button after 2 seconds
                setTimeout(() => {
                    launchButton.disabled = false;
                    launchButton.innerHTML = originalText;
                    launchButton.classList.remove('btn-error');
                }, 2000);

                alert('Error setting up account: ' + error.message);
            }
        }

        // Launch account with local profile (Launch button)
        async function launchAccountLocal(accountId) {
            // Find the launch local button for this account
            const launchLocalButton = event.target.closest('button');
            const originalText = launchLocalButton.innerHTML;

            try {
                // Show loading state
                launchLocalButton.disabled = true;
                launchLocalButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Launching...';
                launchLocalButton.classList.add('btn-launching-local');

                const response = await fetch(`/launch_account_local/${accountId}`, {
                    method: 'GET'
                });

                const result = await response.json();

                if (result.success) {
                    // Show success state
                    launchLocalButton.innerHTML = '<i class="fas fa-check"></i> Launched!';
                    launchLocalButton.classList.remove('btn-launching-local');
                    launchLocalButton.classList.add('btn-launched-local');

                    // Reset button after 3 seconds
                    setTimeout(() => {
                        launchLocalButton.disabled = false;
                        launchLocalButton.innerHTML = originalText;
                        launchLocalButton.classList.remove('btn-launched-local');
                    }, 3000);

                    console.log('Local browser session started successfully! ' + result.message);
                } else {
                    // Show error state
                    launchLocalButton.innerHTML = '<i class="fas fa-times"></i> Error';
                    launchLocalButton.classList.remove('btn-launching-local');
                    launchLocalButton.classList.add('btn-error-local');

                    // Reset button after 2 seconds
                    setTimeout(() => {
                        launchLocalButton.disabled = false;
                        launchLocalButton.innerHTML = originalText;
                        launchLocalButton.classList.remove('btn-error-local');
                    }, 2000);

                    alert('Error launching account locally: ' + result.message);
                }
            } catch (error) {
                // Show error state
                launchLocalButton.innerHTML = '<i class="fas fa-times"></i> Error';
                launchLocalButton.classList.remove('btn-launching-local');
                launchLocalButton.classList.add('btn-error-local');

                // Reset button after 2 seconds
                setTimeout(() => {
                    launchLocalButton.disabled = false;
                    launchLocalButton.innerHTML = originalText;
                    launchLocalButton.classList.remove('btn-error-local');
                }, 2000);

                alert('Error launching account locally: ' + error.message);
            }
        }

        // Backup profile with extensions (Save button)
        async function backupWithExtension(accountId) {
            // Find the backup extension button for this account
            const backupButton = event.target.closest('button');
            const originalText = backupButton.innerHTML;

            // Confirmation dialog since this might close the browser
            if (!confirm('This will backup your current browser profile with extensions to Supabase. If the browser is open, it will be closed during backup. Continue?')) {
                return;
            }

            try {
                // Show loading state
                backupButton.disabled = true;
                backupButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Backing up...';
                backupButton.classList.add('btn-backup-ext');

                const response = await fetch(`/backup_with_extension/${accountId}`, {
                    method: 'GET'
                });

                const result = await response.json();

                if (result.success) {
                    // Show success state
                    backupButton.innerHTML = '<i class="fas fa-check"></i> Backed up!';
                    backupButton.classList.remove('btn-backup-ext');
                    backupButton.classList.add('btn-backup-success');

                    // Reset button after 5 seconds
                    setTimeout(() => {
                        backupButton.disabled = false;
                        backupButton.innerHTML = originalText;
                        backupButton.classList.remove('btn-backup-success');
                    }, 5000);

                    console.log('Profile with extensions backed up successfully! ' + result.message);
                    alert('Profile with extensions backed up successfully! You can now use "Launch" for future launches.');
                } else {
                    // Show error state
                    backupButton.innerHTML = '<i class="fas fa-times"></i> Error';
                    backupButton.classList.remove('btn-backup-ext');
                    backupButton.classList.add('btn-backup-error');

                    // Reset button after 2 seconds
                    setTimeout(() => {
                        backupButton.disabled = false;
                        backupButton.innerHTML = originalText;
                        backupButton.classList.remove('btn-backup-error');
                    }, 2000);

                    alert('Error backing up profile with extensions: ' + result.message);
                }
            } catch (error) {
                // Show error state
                backupButton.innerHTML = '<i class="fas fa-times"></i> Error';
                backupButton.classList.remove('btn-backup-ext');
                backupButton.classList.add('btn-backup-error');

                // Reset button after 2 seconds
                setTimeout(() => {
                    backupButton.disabled = false;
                    backupButton.innerHTML = originalText;
                    backupButton.classList.remove('btn-backup-error');
                }, 2000);

                alert('Error backing up profile with extensions: ' + error.message);
            }
        }
    </script>
{% endblock %}